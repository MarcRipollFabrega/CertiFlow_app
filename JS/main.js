// A JS/main.js

import { initializePasswordSetup } from "./password-setup.js";

document.addEventListener("DOMContentLoaded", () => {
  // === 1. CONFIGURACI√ì SUPABASE (VALORS NECESSARIS PER A L'SDK) ===

  // üì¢ ATENCI√ì: L'URL es mant√© visible, ja que no √©s un secret.
  const SUPABASE_URL = "https://eptthzlpezbmfmnhshkj.supabase.co";

  // üì¢ ATENCI√ì: La clau ANON ha de ser visible perqu√® l'SDK funcioni (√©s una clau p√∫blica).
  // SUBSTITUEIX AQUEST VALOR AMB LA TEVA CLAU ANON REAL
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwdHRoemxwZXpibWZtbmhzaGtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDE4ODIsImV4cCI6MjA3NjIxNzg4Mn0.l_Twgr8Y2sDpmztHVCGiGVrqnIfo8jz58TXTq3kmtD0";

  // URL de la nova funci√≥ Edge que gestiona el login
  const LOGIN_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/api-login`;
  //Alta usuari
  const ALTA_USUARIS_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/api-alta`;

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  window.ALTA_USUARIS_FUNCTION_URL = ALTA_USUARIS_FUNCTION_URL;
  window.supabaseClient = supabaseClient;

  // === 2. REFER√àNCIES ALS ELEMENTS DEL DOM ===
  const appContainer = document.getElementById("app-container");

  // VISTES INTERCANVIABLES DINS DE .login-right
  const loginView = document.getElementById("loginView"); // Contenidor del Login
  const setPasswordContainer = document.getElementById("setPasswordContainer"); // Contenidor Set Password

  // Elements del formulari de Login
  const loginForm = document.getElementById("loginForm");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginButton = document.getElementById("loginButton");

  // Elements del formulari Set Password (mantinguts com a refer√®ncia)
  const setPasswordForm = document.getElementById("setPasswordForm");

  // === 3. FUNCIONS AUXILIARS ===

  function showToast(message, type) {
    const toastContainer = document.getElementById("toast-container");
    if (!toastContainer) return;

    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.textContent = message;

    toastContainer.appendChild(toast);

    // Fade in
    setTimeout(() => {
      toast.style.opacity = "1";
    }, 10);

    // Fade out and remove (4 segons)
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 500);
    }, 4000);
  }

  function loadAppDashboard() {
    // Aquesta funci√≥ carrega la vista del dashboard un cop autenticat
    if (appContainer) {
      // 1. Canvi de classes per a la nova vista
      appContainer.classList.remove("login-container");
      appContainer.classList.add("app-layout");

      // 2. Injecta el nou HTML del Dashboard
      appContainer.innerHTML = `
            <header class="top-app-bar" id="app-header">
                
                <div class="logo-container">
                    <img src="img/logo.png" alt="CertiFlow Logo" class="logo-icon">
                    <div class="app-logo">
                        <span>Certi</span><span class="logo-accent">Flow</span>
                    </div>
                </div>

                <div class="header-actions"> 
                    <label class="toggle-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle" />
                        <span class="slider round"></span>
                    </label>
                </div>
            </header>
            
            <nav class="side-navigation" id="app-nav"></nav>
                
            <main class="main-content-area" id="main-app-content">
                <div class="loading-spinner"></div>
            </main>
            
            <footer class="bottom-app-bar" id="app-footer">
                <div class="footer-info" id="user-info-footer"></div>
                
                <div class="footer-menu-container">
                    <ul id="navbar-menu" class="navbar-menu">
                        <li data-id="enviar" class="list active"> <a href="#enviar">
                                <span class="icon">üì§</span>
                                <span class="text">Enviar</span>
                            </a>
                        </li>
                        <li data-id="consultar" class="list">
                            <a href="#consultar">
                                <span class="icon">üîç</span>
                                <span class="text">Consultar</span>
                            </a>
                        </li>
                        <li data-id="admin" class="list visually-hidden">
                            <a href="#admin">
                                <span class="icon">‚öôÔ∏è</span>
                                <span class="text">Admin</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="footer-logout" id="logout-footer-container"></div>
            </footer>
        `;

      // 3. L√íGICA DEL TEMA (Ha de venir despr√©s de que el DOM s'hagi actualitzat)
      const themeToggle = document.getElementById("theme-toggle");
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme === "light") {
        document.body.classList.add("light-mode");
        if (themeToggle) themeToggle.checked = true;
      } else {
        document.body.classList.remove("light-mode");
        if (themeToggle) themeToggle.checked = false;
      }

      if (themeToggle) {
        themeToggle.addEventListener("change", () => {
          document.body.classList.toggle("light-mode");

          if (document.body.classList.contains("light-mode")) {
            localStorage.setItem("theme", "light");
          } else {
            localStorage.setItem("theme", "dark");
          }
        });
      }

      // 4. C√†rrega din√†mica del codi del dashboard
      const dashboardScriptId = "dashboard-script";
      if (!document.getElementById(dashboardScriptId)) {
        const script = document.createElement("script");
        script.id = dashboardScriptId;
        script.src = "/JS/dashboard.js";
        script.onload = () => {
          if (window.renderDashboard) {
            window.renderDashboard();
          }
        };
        document.body.appendChild(script);
      } else {
        if (window.renderDashboard) {
          window.renderDashboard();
        }
      }
    }
  }

  // === 4. L√íGICA DE GESTI√ì DE CONTRASENYA SEGURA ===

  // üõë PAS CLAU: Intentem inicialitzar el flux segur PRIMER.
  const isInPasswordSetupMode = initializePasswordSetup(supabaseClient);

  if (isInPasswordSetupMode) {
    console.log(
      "Password Setup mode gestionat amb √®xit. S'atura la l√≤gica de checkSession."
    );
    return; // ‚¨ÖÔ∏è AQUEST RETURN √âS CRUCIAL
  }

  // === 5. L√íGICA D'AUTENTICACI√ì (SESSI√ì NORMAL) ===

  async function checkSession() {
    // 1. Assegurar que l'estat d'autenticaci√≥ es resol abans de continuar.
    let session = null;
    let authReady = false;

    return new Promise((resolve) => {
      const { data: listener } = supabaseClient.auth.onAuthStateChange(
        async (event, currentSession) => {
          if (!authReady) {
            session = currentSession;
            authReady = true;
            listener.subscription.unsubscribe();
            resolve();
          }
        }
      );
      setTimeout(() => {
        if (!authReady) {
          supabaseClient.auth
            .getSession()
            .then(({ data }) => {
              session = data.session;
              resolve();
            })
            .catch(resolve);
        }
      }, 500);
    }).then(async () => {
      // La l√≤gica de hash (handleInitialView) ja NO √©s aqu√≠.

      // 2. L√≤gica normal: Si hi ha sessi√≥, carregar dashboard
      if (session) {
        console.log("Sessi√≥ activa. Carregant Dashboard.");
        loadAppDashboard();
      } else {
        // 3. NO HI HA SESSI√ì. MOSTRA EL FORMULARI DE LOGIN
        console.log("No hi ha sessi√≥. Mostrant Login.");
        // Assegurar que el loginView √©s visible i SetPasswordContainer est√† ocult
        if (loginView) loginView.style.display = "block";
        if (setPasswordContainer) setPasswordContainer.style.display = "none";
      }
    });
  }

  // === 6. LISTENER DEL FORMULARI D'INICI DE SESSI√ì NORMAL ===

  if (loginForm) {
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        showToast("Tots els camps s√≥n obligatoris.", "error");
        return;
      }

      loginButton.disabled = true;
      loginButton.textContent = "Verificant...";

      // =======================================================
      //  CRIDA SEGURA AL EDGE FUNCTION
      // =======================================================
      let data, error;
      let sessionData = null;

      try {
        const response = await fetch(LOGIN_FUNCTION_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email, password }),
        });

        const result = await response.json();

        if (!response.ok || result.error) {
          error = result;
        } else {
          sessionData = result.session;
          data = result;
        }
      } catch (err) {
        error = {
          message: "Error de connexi√≥ amb el servidor d'autenticaci√≥.",
        };
        console.error("Fetch Error:", err);
      }
      // =======================================================

      if (error) {
        console.error("Error Edge Function Auth:", error);
        showToast(
          "Error: Credencials incorrectes o l'usuari no existeix.",
          "error"
        );
      } else if (data.user && sessionData) {
        const { error: sessionError } = await supabaseClient.auth.setSession(
          sessionData
        );

        if (sessionError) {
          console.error("Error establint la sessi√≥:", sessionError);
          showToast("Error establint la sessi√≥.", "error");
        } else {
          // üõ†Ô∏è MOSTRAR EL TOAST D'√àXIT IMMEDIATAMENT
          showToast(
            "Inici de sessi√≥ correcte! Carregant aplicaci√≥...",
            "success"
          );

          setTimeout(() => {
            loadAppDashboard();
          }, 4600);
        }
      } else {
        showToast("Error desconegut durant l'autenticaci√≥.", "error");
      }

      loginButton.disabled = false;
      loginButton.textContent = "Accedir";
    });
  }

  checkSession();
});
