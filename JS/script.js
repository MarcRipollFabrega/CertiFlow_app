document.addEventListener("DOMContentLoaded", () => {
  // === 1. CONFIGURACI√ì SUPABASE (SUBSTITUEIX AMB ELS TEUS VALORS REALS) ===
  // *** IMPORTANT: Canvieu aquests valors NOM√âS AQU√ç ***
  // Assegureu-vos que aquestes claus s√≥n les del vostre projecte Supabase
  const SUPABASE_URL = "https://eptthzlpezbmfmnhshkj.supabase.co"; // ‚¨ÖÔ∏è SUBSTITUIR AQU√ç
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwdHRoemxwZXpibWZtbmhzaGtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDE4ODIsImV4cCI6MjA3NjIxNzg4Mn0.l_Twgr8Y2sDpmztHVCGiGVrqnIfo8jz58TXTq3kmtD0"; // ‚¨ÖÔ∏è SUBSTITUIR AQU√ç

  // Inicialitzar el client de Supabase.
  // √ös de 'window.supabase.createClient' per evitar l'error 'ReferenceError'
  // amb la variable local 'supabase'.
  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  // *** SOLUCI√ì PER A LA DUPLICITAT: Exposar el client Supabase globalment ***
  // Aix√≤ permet a dashboard.js accedir-hi sense duplicar les claus.
  window.supabaseClient = supabaseClient;

  // === 2. ELEMENTS DEL DOM ===
  const loginForm = document.getElementById("loginForm");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const toastContainer = document.getElementById("toast-container");
  const appContainer = document.getElementById("app-container");
  const loginButton = document.getElementById("loginButton");

  // === 3. FUNCIONS D'UTILITAT ===

  // Funci√≥ per mostrar un missatge Toast (notificaci√≥)
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;

    let icon = "";
    if (type === "success") {
      icon = "‚úÖ";
    } else if (type === "error") {
      icon = "‚ùå";
    }

    toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;

    toastContainer.appendChild(toast);

    // Mostrar amb animaci√≥
    setTimeout(() => {
      toast.classList.add("show");
    }, 10);

    // Amagar i eliminar despr√©s de 5 segons
    setTimeout(() => {
      toast.classList.remove("show");
      // Esperar la transici√≥ abans d'eliminar
      toast.addEventListener("transitionend", () => {
        toast.remove();
      });
    }, 5000);
  }

  // === 4. C√ÄRREGA DEL DASHBOARD ===

  // Funci√≥ per amagar el login i carregar din√†micament l'script del dashboard
  function loadAppDashboard() {
    // 1. Amagar el formulari de login
    appContainer.style.opacity = 0;
    appContainer.innerHTML = ""; // Eliminar el contingut de login

    // 2. Crear el contenidor principal de l'aplicaci√≥
    const mainContent = document.createElement("div");
    mainContent.id = "main-app-content";
    appContainer.appendChild(mainContent);

    // 3. Afegir el nou script (dashboard.js)
    const script = document.createElement("script");

    // üî• CORRECCI√ì DE LA RUTA: Afegim 'JS/' perqu√® el fitxer hi √©s
    script.src = "JS/dashboard.js";
    script.type = "module"; // Utilitzar m√≤dul per resoldre l'acc√©s global a 'supabaseClient'
    document.body.appendChild(script);

    // 4. Mostrar el contenidor del dashboard amb transici√≥
    setTimeout(() => {
      appContainer.style.opacity = 1;
    }, 50); // Petit retard per a la transici√≥
  }

  // === 5. GESTI√ì DEL LOGIN ===

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    // Validaci√≥ b√†sica de camps buits
    if (!email || !password) {
      showToast("Tots els camps s√≥n obligatoris.", "error");
      return;
    }

    // Deshabilitar el bot√≥ mentre processa
    loginButton.disabled = true;
    loginButton.textContent = "Verificant...";

    // 1. Crida a la funci√≥ d'autenticaci√≥ de Supabase
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: email,
      password: password,
    });

    if (error) {
      console.error("Error Supabase Auth:", error);
      showToast(
        "Error: Credencials incorrectes o l'usuari no existeix.",
        "error"
      );
    } else if (data.user) {
      // 2. Inici de sessi√≥ exit√≥s
      showToast("Inici de sessi√≥ correcte! Carregant aplicaci√≥...", "success");

      setTimeout(() => {
        loadAppDashboard();
      }, 1000);
    } else {
      showToast("Error desconegut durant l'autenticaci√≥.", "error");
    }

    loginButton.disabled = false;
    loginButton.textContent = "Accedir";
  });

  // === 6. VERIFICAR LA SESSI√ì AL CARREGAR LA P√ÄGINA ===
  // Aix√≤ permet a l'usuari mantenir la sessi√≥ si refresca la p√†gina.
  supabaseClient.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      // Si la sessi√≥ ja existeix, carreguem el dashboard directament
      loadAppDashboard();
    }
  });
});
