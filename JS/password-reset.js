// Fitxer: ../JS/password-reset.js

/**
 * Funci√≥ que crea la interf√≠cie per establir la contrasenya inicial.
 * Aquesta funci√≥ es crida si un usuari loguejat (amb sessi√≥, per exemple, despr√©s d'una invitaci√≥)
 * no ha configurat pr√®viament la seva contrasenya.
 * * @param {object} supabaseClient - El client de Supabase inicialitzat.
 * @param {function} loadAppDashboard - Funci√≥ per carregar l'aplicaci√≥ principal despr√©s de l'√®xit.
 * @returns {HTMLElement} El div contenidor del formulari de contrasenya.
 */
export function createPasswordSetupForm(supabaseClient, loadAppDashboard) {
  const container = document.createElement("div");
  // Utilitzem classes de l'estructura del teu login (per exemple, si el teu dashboard.html t√© un contenidor principal amb flex)
  container.className = "login-container";

  container.innerHTML = `
        <div class="login-right" style="flex: 10;"> 
            <div class="login-form-wrapper">
                <h1 class="login-title">üîí Estableix la Teva Contrasenya</h1>
                <p class="login-subtitle">Ja has confirmat el teu acc√©s. Crea la teva contrasenya per finalitzar l'activaci√≥.</p>

                <form id="passwordSetupForm" class="login-form">
                    <div class="input-group">
                        <input type="password" id="newPassword" placeholder=" " required minlength="6">
                        <label for="newPassword" class="floating-label">Nova Contrasenya:</label>
                    </div>
                    <div class="input-group">
                        <input type="password" id="confirmPassword" placeholder=" " required minlength="6">
                        <label for="confirmPassword" class="floating-label">Confirma Contrasenya:</label>
                    </div>
                    
                    <button type="submit" id="setPasswordButton">
                        Establir Contrasenya
                    </button>
                    <p id="passwordStatusMessage" class="status-message"></p>
                </form>
            </div>
        </div>
    `;

  const form = container.querySelector("#passwordSetupForm");
  const newPasswordInput = container.querySelector("#newPassword");
  const confirmPasswordInput = container.querySelector("#confirmPassword");
  const statusMessage = container.querySelector("#passwordStatusMessage");
  const setPasswordButton = container.querySelector("#setPasswordButton");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    setPasswordButton.disabled = true;
    setPasswordButton.textContent = "Guardant... ‚è≥";
    statusMessage.textContent = "";
    statusMessage.className = "status-message";

    const newPassword = newPasswordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();

    if (newPassword !== confirmPassword) {
      statusMessage.textContent = "‚ùå Les contrasenyes no coincideixen.";
      statusMessage.className = "status-message error";
      setPasswordButton.disabled = false;
      setPasswordButton.textContent = "Establir Contrasenya";
      return;
    }

    try {
      // Pas 4: Actualitzar la contrasenya i marcar l'usuari com a 'configurat'
      const { error } = await supabaseClient.auth.updateUser({
        password: newPassword,
        data: {
          initial_setup: true, // Marcar que la contrasenya ja ha estat establerta
        },
      });

      if (error) {
        console.error("Error al guardar contrasenya:", error);
        statusMessage.textContent = `‚ùå Error al guardar contrasenya: ${error.message}`;
        statusMessage.className = "status-message error";
      } else {
        // √âXIT
        statusMessage.textContent =
          "‚úÖ Contrasenya establerta amb √®xit! Carregant aplicaci√≥...";
        statusMessage.className = "status-message success";
        form.reset();

        // Un petit retard per mostrar el missatge d'√®xit abans de carregar el dashboard
        setTimeout(() => {
          loadAppDashboard();
        }, 1500);
      }
    } catch (error) {
      console.error("Fetch Error:", error);
      statusMessage.textContent = "‚ùå Error de connexi√≥.";
      statusMessage.className = "status-message error";
    } finally {
      setPasswordButton.disabled = false;
      setPasswordButton.textContent = "Establir Contrasenya";
    }
  });

  return container;
}
