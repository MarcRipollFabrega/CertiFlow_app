/**
 * enviar.js
 * Cont√© la l√≤gica i la creaci√≥ de la vista 'Enviar', incloent la previsualitzaci√≥ d'arxius
 * i els camps de formulari actualitzats (Tipus document, T√®cnic, Data, Prove√Ødor, Import).
 */

// Funci√≥ per carregar la previsualitzaci√≥ de l'arxiu (Utilitza IFRAME)
function setupFileUploadListener(wrapper) {
  // üõ†Ô∏è Canvi de 'component' a 'wrapper'
  const fileInput = wrapper.querySelector("#file_upload");
  const pdfViewer = wrapper.querySelector("#pdf_viewer");

  if (fileInput && pdfViewer) {
    let previousFileURL = null;

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];

      // Netejar la URL anterior si n'hi ha una
      if (previousFileURL) {
        URL.revokeObjectURL(previousFileURL);
        previousFileURL = null;
      }

      if (file) {
        if (file.type === "application/pdf") {
          // 1. Crear URL de l'objecte local i guardar la refer√®ncia
          const fileURL = URL.createObjectURL(file);
          previousFileURL = fileURL;

          // 2. Inserir l'iframe que utilitzar√† el visualitzador natiu del navegador
          pdfViewer.innerHTML = `
                        <iframe 
                            src="${fileURL}" 
                            style="width: 100%; height: 100%; border: none;">
                        </iframe>
                    `;
        } else {
          pdfViewer.innerHTML = `<div class="pdf-placeholder-text">‚ùå Nom√©s s'accepten arxius PDF.</div>`;
        }
      } else {
        pdfViewer.innerHTML = `<div class="pdf-placeholder-text">Previsualitzaci√≥ del Document</div>`;
      }
    });
  }
}

// üåü NOVA FUNCI√ì: Carrega el fitxer JS de la l√≤gica d'enviament
function loadSubmitScript(e) {
  e.preventDefault(); // Evita l'acci√≥ per defecte del bot√≥ si n'hi hagu√©s

  // Ruta de l'arxiu de l√≤gica d'enviament (S'assumeix que √©s a la carpeta JS)
  const scriptPath = "../JS/submit_logic.js";

  // 1. Comprova si l'script ja s'ha carregat per evitar duplicats
  // (Podem comentar aquesta part si volem que s'executi cada vegada)
  /*
    if (document.querySelector(`script[src="${scriptPath}"]`)) {
        console.warn("L'script de la l√≤gica d'enviament ja est√† carregat.");
        return; 
    }
    */

  // 2. Crea i injecta l'element script
  const script = document.createElement("script");
  script.src = scriptPath;
  script.id = "submit-logic-script";

  script.onload = () => {
    console.log(`‚úÖ Arxiu ${scriptPath} carregat i executat!`);
  };

  document.body.appendChild(script);
}

// Exportem la funci√≥ de creaci√≥ del component
export function createEnviarComponent() {
  // üõ†Ô∏è 1. Crear el contenidor principal amb la classe de layout
  const wrapper = document.createElement("div");
  wrapper.classList.add("dashboard-wrapper"); // ‚¨ÖÔ∏è CLAU per aplicar el display: flex

  // COLUMNA ESQUERRA (Formulari + C√†rrega)
  const leftColumn = document.createElement("div");
  leftColumn.classList.add("service-column", "vertical-split");

  // ----------------------------------------------------
  // SECCI√ì SUPERIOR: Camps de Formulari
  // ----------------------------------------------------
  const topSection = document.createElement("div");
  topSection.innerHTML = `
            <h2 class="section-title">Nou Document</h2>

<div class="form-group-inline">
    <label for="tipus_contracte">Tipus de Contracte:</label>
    <select id="tipus_contracte" class="form-select">
        <option value="" disabled selected>Selecciona un tipus</option>
        <option value="menor">Menor</option>
        <option value="licitacio">Licitaci√≥</option>
        <option value="fora_lcsp">Fora LCSP</option>
    </select>
</div>

            <div class="form-group-inline">
    <label for="tecnic">T√®cnic:</label>
    <input 
        type="text" 
        id="tecnic" 
        class="form-input" 
        list="llistaTecnics" 
        placeholder="Escriu el nom del t√®cnic"
    ></div>

            <div class="form-group-inline">
                <label for="data">Data:</label>
                <input type="date" id="data" class="form-input">
            </div>

            <div class="form-group-inline">
                <label for="proveidor">Prove√Ødor:</label>
                <input type="text" id="proveidor" class="form-input" placeholder="Nom del Prove√Ødor">
            </div>

            <div class="form-group-inline">
                <label for="import">Import (‚Ç¨):</label>
                <input type="number" id="import" class="form-input" placeholder="0.00" step="0.01">
            </div>
        `;

  // ----------------------------------------------------
  // SECCI√ì INFERIOR: C√†rrega d'Arxiu (üåü Amb ID al bot√≥)
  // ----------------------------------------------------
  const bottomSection = document.createElement("div");
  bottomSection.innerHTML = `
            <h3>C√†rrega d'Arxiu üìé</h3>
            <input type="file" id="file_upload" class="file-input" accept=".pdf"> 
            
            <button id="submitButton" class="action-button primary-action-button" style="margin-top: 15px;">
                Enviar
            </button>
        `;

  leftColumn.appendChild(topSection);
  leftColumn.appendChild(bottomSection);

  // COLUMNA DRETA (Visualitzador PDF)
  const rightColumn = document.createElement("div");
  rightColumn.classList.add("service-column", "pdf-viewer-column");
  rightColumn.innerHTML = `
            <h3>Visualitzador PDF</h3>
            <div id="pdf_viewer" class="pdf-placeholder">
                <div class="pdf-placeholder-text">Previsualitzaci√≥ del Document</div>
            </div>
        `;

  // üõ†Ô∏è 2. Afegir les columnes al 'wrapper' (el contenidor que es retorna)
  wrapper.appendChild(leftColumn);
  wrapper.appendChild(rightColumn);

  // üõ†Ô∏è 3. Cridar el listener de c√†rrega d'arxiu al 'wrapper'
  setupFileUploadListener(wrapper);

  // üåü 4. AFEGIR LISTENER AL BOT√ì 'ENVIAR'
  const submitButton = wrapper.querySelector("#submitButton");
  if (submitButton) {
    submitButton.addEventListener("click", loadSubmitScript);
  }

  // üõ†Ô∏è 5. Retornar el contenidor correcte
  return wrapper;
}
