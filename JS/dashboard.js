// Aquest script s'executa un cop l'usuari ha iniciat sessi√≥ correctament.

const supabase = window.supabaseClient;

/**
 * Funci√≥ per tancar la sessi√≥
 */
async function handleLogout() {
  const { error } = await supabase.auth.signOut();
  if (error) {
    console.error("Error al tancar la sessi√≥:", error);
    // showToast("Error al tancar la sessi√≥.", "error"); // Assumeix la funci√≥ showToast global
  } else {
    // Redireccionar o recarregar per mostrar la pantalla de login
    window.location.reload();
  }
}

/**
 * 1. OBTENIR EL ROL I NOM DE L'USUARI DES DE LA TAULA 'usuaris'
 */
async function getUserRole() {
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    console.error("Usuari no trobat. Redireccionant...");
    window.location.reload();
    return null;
  }

  // S'assumeix que la taula 'usuaris' t√© els camps 'role' i 'nom'
  const { data: userData, error } = await supabase
    .from("usuaris")
    .select("role, nom")
    .eq("id", user.id)
    .single();

  if (error || !userData) {
    console.error("Error al carregar el rol de l'usuari:", error);
    // Si falla, es pot mostrar un missatge a l'usuari
    const mainContent = document.getElementById("main-app-content");
    if (mainContent) {
      mainContent.innerHTML = `<div class="error-message">‚ùå Error al carregar les dades del perfil.</div>`;
    }
    return null;
  }

  return userData;
}

// ‚ö†Ô∏è Mantenim aquesta funci√≥ de moment, per√≤ no es fa servir per a la navegaci√≥ principal
function getRoleSpecificContent(role) {
  return `
        <div class="dashboard-menu">
            <a href="#" class="menu-item menu-common">
                <h3>Visualitzar Historial</h3>
                <p>Accedeix a l'historial de documents.</p>
            </a>
        </div>
    `;
}

// =======================================================
// üåüüåü NOU: FUNCI√ì AUXILIAR PER CARREGAR CSS DIN√ÄMICAMENT üåüüåü
// =======================================================

/**
 * Carrega un fitxer CSS din√†micament si encara no est√† carregat.
 * @param {string} href - El path del fitxer CSS (ex: '../CSS/admin.css').
 * @param {string} id - L'ID del link a comprovar/crear (ex: 'admin-styles').
 */
function loadCSS(href, id) {
  if (document.getElementById(id)) {
    return; // Ja carregat, sortir
  }
  const link = document.createElement("link");
  link.id = id;
  link.rel = "stylesheet";
  link.type = "text/css";
  link.href = href;
  document.head.appendChild(link);
}

// =======================================================
// üåüüåü FUNCI√ì CORREGIDA PER LA C√ÄRREGA DE COMPONENTS üåüüåü
// =======================================================

/**
 * Funci√≥ per carregar components din√†micament
 * @param {string} componentName - Nom del component a carregar ('enviar', 'consultar', 'admin').
 */
async function loadComponent(componentName) {
  const mainContent = document.getElementById("main-app-content");
  if (!mainContent) return;

  // Netegem el contingut principal
  mainContent.innerHTML = "";

  // Netegem l'script de l√≤gica d'enviament si est√† carregat (per si l'usuari navega fora i torna)
  const dynamicScript = document.getElementById("submit-logic-script");
  if (dynamicScript) {
    dynamicScript.remove();
  }

  // Casos de C√†rrega
  switch (componentName) {
    case "enviar":
      try {
        // Importem din√†micament el m√≤dul 'enviar.js'
        const EnviarModule = await import("../JS/enviar.js");

        // 1. Creem l'element component
        const enviarElement = EnviarModule.createEnviarComponent();

        // 2. Injectem el DOM al contenidor principal
        mainContent.appendChild(enviarElement);
      } catch (error) {
        console.error("Error al carregar el component Enviar:", error);
        mainContent.innerHTML = `<div class="error-message">‚ùå Error al carregar el formulari d'enviament. Assegura't que 'enviar.js' sigui un m√≤dul v√†lid (export function...).</div>`;
      }
      break;

    case "consultar":
      mainContent.innerHTML = `
                <div class="dashboard-wrapper">
                    <h2 class="section-title">Opcio CONSULTAR</h2>
                    <p>Has fet clic a üîç **CONSULTAR**. Aqu√≠ anir√† la taula de cerca d'historials.</p>
                </div>`;
      break;

    case "admin":
      // üåüüåü MODIFICACI√ì CLAU PER AL LAYOUT DE 4 PARTS üåüüåü
      try {
        // 1. Carregar el full d'estils d'administraci√≥
        loadCSS("../CSS/admin.css", "admin-styles");

        // 2. Injectar l'esquelet del layout d'administraci√≥ (4 columnes/quadrants)
        mainContent.innerHTML = `
                <div class="admin-wrapper">
                    <h2 class="section-title">Administraci√≥ del Sistema</h2>

                    <div class="admin-grid-layout">
                        
                        <div class="admin-quadrant admin-quadrant-1" id="altaUsuarisContainer">
                            </div>
                        
                        <div class="admin-quadrant admin-quadrant-2">
                            <h3 class="crud-title">Taula de Llistat d'Usuaris</h3>
                            <p>Aqu√≠ anir√† el llistat d'usuaris amb opcions d'edici√≥ i eliminaci√≥.</p>
                        </div>
                        
                        <div class="admin-quadrant admin-quadrant-3">
                            <h3 class="crud-title">Gesti√≥ de Rols</h3>
                            <p>Eines per crear, modificar i assignar rols.</p>
                        </div>
                        
                        <div class="admin-quadrant admin-quadrant-4">
                            <h3 class="crud-title">Monitoritzaci√≥</h3>
                            <p>Logs i estad√≠stiques d'√∫s del sistema (Edge Functions, etc.).</p>
                        </div>
                    </div>
                </div>
            `;

        // 3. Carregar el m√≤dul del CRUD i injectar-lo al quadrant 1
        // (Aix√≤ requereix que el fitxer 'alta-usuaris-crud.js' existeixi)
        const AltaUsuarisModule = await import("../JS/alta-usuaris-crud.js");
        const crudElement = AltaUsuarisModule.createAltaUsuarisCRUD();

        const altaContainer = document.getElementById("altaUsuarisContainer");
        if (altaContainer) {
          altaContainer.appendChild(crudElement);
        }
      } catch (error) {
        console.error("Error al carregar el component Admin o CRUD:", error);
        mainContent.innerHTML = `<div class="error-message">‚ùå Error al carregar la vista d'Administraci√≥. Verifica la ruta o el contingut de 'alta-usuaris-crud.js'.</div>`;
      }
      break;

    default:
      mainContent.innerHTML = `<div class="error-message">P√†gina no trobada (${componentName}).</div>`;
      break;
  }
}

/**
 * GESTOR DE NAVEGACI√ì
 */
function handleNavigation(targetId) {
  // Aquesta funci√≥ s'ha de fer 'async' ja que crida a 'loadComponent' que ara √©s 'async'
  (async () => {
    const navItems = document.querySelectorAll("#navbar-menu .list");
    const newComponent = targetId.replace("#", "");

    // 1. Eliminar 'active' de tots i afegir-lo al seleccionat
    navItems.forEach((item) => {
      item.classList.remove("active");
      if (item.getAttribute("data-id") === newComponent) {
        item.classList.add("active");
      }
    });

    // 2. Carregar el component corresponent
    await loadComponent(newComponent); // üåü Crida as√≠ncrona
  })();
}

// =======================================================
// 3. MOSTRAR EL CONTINGUT DEL DASHBOARD (Vista Inicial) I PEU DE P√ÄGINA
// =======================================================

/**
 * Funci√≥ principal que configura el dashboard
 */
async function renderDashboard() {
  const mainContent = document.getElementById("main-app-content");
  const logoutFooterContainer = document.getElementById(
    "logout-footer-container"
  );
  const userInfoFooter = document.getElementById("user-info-footer");
  const navbarMenu = document.getElementById("navbar-menu"); // Element ul

  // ... (Validacions d'elements HTML - ometrem-les aqu√≠ per brevetat)

  const userData = await getUserRole();

  if (!userData) {
    return;
  }

  const { nom, role } = userData;
  const roleClass = `role-${role.replace(/\s/g, "").toLowerCase()}`;
  const userName = nom || "Usuari Desconegut";

  // 1. CARREGAR EL CONTINGUT PER DEFECTE (ENVIAR)
  const enviarMenuItem = document.querySelector(
    "#navbar-menu .list[data-id='enviar']"
  );
  if (enviarMenuItem) {
    enviarMenuItem.classList.add("active"); // Assegura que l'element de men√∫ estigui actiu
  }
  await loadComponent("enviar"); // ‚¨ÖÔ∏è Carrega el contingut inicial del component "enviar"

  // 2. INJECTAR NOM D'USUARI I ROL AL PEU DE P√ÄGINA
  userInfoFooter.innerHTML = `
        <p class="footer-user-info">
            Usuari: <strong>${userName}</strong> 
            (<span class="${roleClass}">${role.toUpperCase()}</span>)
        </p>
    `;

  // 3. GENERAR EL BOT√ì DE TANCAR SESSI√ì AL PEU
  logoutFooterContainer.innerHTML = `
        <button id="logoutButton" class="logout-button">
            Tancar Sessi√≥
        </button>
    `;

  // 4. Afegir listener al bot√≥ de tancar sessi√≥
  const logoutButton = document.getElementById("logoutButton");
  if (logoutButton) {
    logoutButton.addEventListener("click", handleLogout);
  }

  // 5. AFEGIR LISTENERS DE NAVEGACI√ì AL MEN√ö
  navbarMenu.addEventListener("click", (e) => {
    const listItem = e.target.closest(".list");
    if (listItem) {
      const anchor = listItem.querySelector("a");
      if (anchor) {
        const targetId = anchor.getAttribute("href");
        e.preventDefault();
        handleNavigation(targetId); // GESTIONA EL CANVI DE PANTALLA
      }
    }
  });
}

// Exposem la funci√≥ al global per ser cridada des de main.js
window.renderDashboard = renderDashboard;
